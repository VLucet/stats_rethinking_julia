<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/stats_rethinking_julia/libs/highlight/github.min.css"> <link rel=stylesheet  href="/stats_rethinking_julia/css/franklin.css"> <link rel=stylesheet  href="/stats_rethinking_julia/css/poole_hyde.css"> <link rel=stylesheet  href="/stats_rethinking_julia/css/custom.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 768px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/stats_rethinking_julia/assets/favicon.png"> <title>Chapter 4</title> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > </div> <style> @media (min-width: 768px) { /* .sidebar-nav { } */ } .sidebar .container.sidebar-sticky { top: 4rem; } .sidebar-nav .sidebar-nav-item.active { box-sizing: border-box; border-bottom: 1px #f1f1f1 solid; margin-right: -1em; margin-left: -0.5em; padding-left: 0.5em; color: white; font-weight: normal !important; } .sidebar-nav .sidebar-nav-item { color: #cccccc; margin: 0.25em 0; } </style> <nav class=sidebar-nav  style="opacity: 0.9"> <a class="sidebar-nav-item " href="/stats_rethinking_julia/">Home</a> <a class="sidebar-nav-item " href="/stats_rethinking_julia/models/">All models</a> <a class="sidebar-nav-item " href="/stats_rethinking_julia/chapters/chap_4/">Chapter 4</a> </nav> <div class=bottom-sidebar > <a href="https://github.com/VLucet/stats_rethinking_julia">Go to GitHub repository &rarr;</a> <br> <br> <a href="https://julialang.org/"><img src="https://raw.githubusercontent.com/JuliaLang/julia-logo-graphics/master/images/julia-logo-dark.svg" height=32  style="display: inline-block; margin-bottom: -8px; opacity: 0.7"> powered.</a> </div> </div> </div> <div class="content container"> <div class=franklin-content > <h1 class=sidebar-title ><a href="/stats_rethinking_julia/">Geocentric<span style="opacity:0.4"> models</span></a></h1> <p>We start first by including the models needed to run the code for this chapter and by setting the seed.</p> <pre><code class=language-julia >include&#40;&quot;src/load_packages.jl&quot;&#41;;
include&#40;&quot;_literate/chap_4_models.jl&quot;&#41;;
Random.seed&#33;&#40;77&#41;;</code></pre> <h2 id=figure_42 ><a href="#figure_42" class=header-anchor >Figure 4.2</a></h2> <p>In Julia, we rely on the package <code>Distributions.jl</code> to sample from a given distribution. Here we sample 16 times from a uniform distribution U ~ &#40;-1, 1&#41;. We now plot the bottom part of <strong>figure 4.2 &#40;page 73&#41;</strong>.</p> <pre><code class=language-julia >U &#61; Uniform&#40;-1,1&#41;
samples &#61; &#91;rand&#40;U, 16&#41; for i in 1:1000&#93;

sum_samples &#61; sum.&#40;samples&#41;
sum_samples_4 &#61; sum.&#40;&#91;samples&#91;i&#93;&#91;1:4&#93; for i in 1:1000&#93;&#41;
sum_samples_8 &#61; sum.&#40;&#91;samples&#91;i&#93;&#91;1:8&#93; for i in 1:1000&#93;&#41;

p_dens &#61; density&#40;sum_samples_4, lab &#61; &quot;4 steps&quot;,
                 linecolor &#61; :blue, linealpha &#61; 0.3&#41;
density&#33;&#40;p_dens, sum_samples_8, lab &#61; &quot;8 steps&quot;,
         linecolor &#61; :red, linealpha &#61; 0.3&#41;
density&#33;&#40;p_dens, sum_samples, lab &#61; &quot;16 steps&quot;,
         linecolor &#61; :green, linealpha &#61; 0.3&#41;
density&#33;&#40;rand&#40;Normal&#40;0, std&#40;sum_samples&#41;&#41;, 100_000&#41;,
         lab &#61; &quot;N ~ &#40;0, 2.18&#41;&quot;, linestyle &#61; :dash&#41;;</code></pre> <p>Now for the top part of the plot.</p> <pre><code class=language-julia >p_paths &#61; plot&#40;&#41;
for path in 1:1000
    plot&#33;&#40;p_paths, 1:17, insert&#33;&#40;cumsum&#40;samples&#91;path&#93;&#41;, 1, 0&#41;, lab &#61; &quot;&quot;,
          linecolor&#61; :darkblue, linealpha &#61; 0.1&#41;
end
vline&#33;&#40;p_paths, &#91;5&#93;, linestyle &#61; :dash, linecolor &#61; :black, lab &#61; &quot;&quot;&#41;
vline&#33;&#40;p_paths, &#91;9&#93;, linestyle &#61; :dash, linecolor &#61; :black, lab &#61; &quot;&quot;&#41;
vline&#33;&#40;p_paths, &#91;17&#93;, linestyle &#61; :dash, linecolor &#61; :black, lab &#61; &quot;&quot;&#41;

figure_4_2 &#61; plot&#40;p_paths, p_dens, layout &#61; &#40;2, 1&#41;&#41;;</code></pre> <img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/figure_4_2.svg" alt=""> <h2 id=figure_43 ><a href="#figure_43" class=header-anchor >Figure 4.3</a></h2> <h3 id=importing_data ><a href="#importing_data" class=header-anchor >Importing data</a></h3> <p>For the rest of the chapter, we use the Howell dataset.</p> <pre><code class=language-julia >data_path &#61; joinpath&#40;TuringModels.project_root, &quot;data&quot;, &quot;Howell1.csv&quot;&#41;
howell &#61; CSV.read&#40;data_path, DataFrame; delim&#61;&#39;;&#39;&#41;
howell &#61; filter&#40;row -&gt; row.age &gt;&#61; 18, howell&#41;
first&#40;howell, 5&#41;</code></pre><pre><code class=plaintext >5×4 DataFrame
 Row │ height   weight   age      male
     │ Float64  Float64  Float64  Int64
─────┼──────────────────────────────────
   1 │ 151.765  47.8256     63.0      1
   2 │ 139.7    36.4858     63.0      0
   3 │ 136.525  31.8648     65.0      0
   4 │ 156.845  53.0419     41.0      1
   5 │ 145.415  41.2769     51.0      0</code></pre> <h3 id=prior_predictive_simulation ><a href="#prior_predictive_simulation" class=header-anchor >Prior predictive simulation</a></h3> <p>It is good to visualize the priors we choose for a given analysis. Here we plot them to reproduce <strong>figure 4.3 &#40;page 83&#41;</strong>.</p> <pre><code class=language-julia >p1 &#61; plot&#40;Normal&#40;178,20&#41;, xlab &#61; &quot;μ&quot;, ylab &#61; &quot;Density&quot;, lab &#61; &quot;&quot;,
          title &#61; &quot;μ ~ N&#40;178, 20&#41;&quot;, linecolor&#61;:blue&#41;

p2 &#61; plot&#40;Uniform&#40;0,50&#41;, xlab &#61; &quot;σ&quot;, ylab &#61; &quot;Density&quot;, lab &#61; &quot;&quot;,
          title &#61; &quot;σ ~ N&#40;0, 50&#41;&quot;, linecolor&#61;:blue,
          xlim&#61;&#91;-10, 60&#93;, ylim&#61;&#91;0, 0.02&#93;&#41;

sample_μ &#61; rand&#40;Normal&#40;178, 20&#41;, 10_000&#41;
sample_μ_2 &#61; rand&#40;Normal&#40;178, 100&#41;, 10_000&#41;
sample_σ &#61; rand&#40;Uniform&#40;0,50&#41;, 10_000&#41;

prior_h &#61; rand.&#40;Normal.&#40;sample_μ, sample_σ&#41;, 1&#41;
p3 &#61; density&#40;reduce&#40;vcat, prior_h&#41;,
             xlab &#61; &quot;height&quot;, ylab &#61; &quot;Density&quot;, lab &#61; &quot;&quot;,
             title &#61; &quot;h ~ N&#40;μ, σ&#41;&quot;&#41;

prior_h_2 &#61; rand.&#40;Normal.&#40;sample_μ_2, sample_σ&#41;, 1&#41;
p4 &#61; density&#40;reduce&#40;vcat, prior_h_2&#41;,
             xlab &#61; &quot;height&quot;, ylab &#61; &quot;Density&quot;, lab &#61; &quot;&quot;,
             title &#61; &quot;h ~ N&#40;μ, σ&#41;\nμ ~ N&#40;178, 100&#41;&quot;&#41;

figure_4_3 &#61; plot&#40;p1, p2, p3, p4, layout &#61; &#40;2, 2&#41;&#41;;</code></pre> <img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/figure_4_3.svg" alt=""> <h2 id=figure_44 ><a href="#figure_44" class=header-anchor >Figure 4.4</a></h2> <h3 id=posterior_grid_approximation ><a href="#posterior_grid_approximation" class=header-anchor >Posterior grid approximation</a></h3> <pre><code class=language-julia >μ_vec &#61; range&#40;150, 160, length &#61; 100&#41;
σ_vec &#61; range&#40;7, 9, length &#61; 100&#41;

post_grid &#61; reduce&#40;vcat, collect&#40;Iterators.product&#40;μ_vec, σ_vec&#41;&#41;&#41;
post_grid_dist &#61; &#91;Normal&#40;t&#91;1&#93;, t&#91;2&#93;&#41; for t in post_grid&#93;
log_likelihood &#61; sum.&#40;&#91;log.&#40;pdf.&#40;d, howell.height&#41;&#41; for d in post_grid_dist&#93;&#41;

all_μ &#61; &#91;p&#91;1&#93; for p in post_grid&#93;
all_σ &#61; &#91;p&#91;2&#93; for p in post_grid&#93;

post_prod &#61; log_likelihood .&#43; log.&#40;pdf&#40;Normal&#40;178, 20&#41;, all_μ&#41;&#41;
                           .&#43; log.&#40;pdf&#40;Uniform&#40;0, 50&#41;, all_σ&#41;&#41;
post_prob &#61; exp.&#40;post_prod .- maximum&#40;post_prod&#41;&#41;;</code></pre> <p>We can make a contour plot of the posterior:</p> <pre><code class=language-julia >contour_plot &#61; contour&#40;μ_vec, σ_vec, post_prob&#41;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/contour_plot.svg" alt="">
<p>Let&#39;s now sample from that posterior</p>
<pre><code class=language-julia >sample_rows &#61; sample&#40;collect&#40;1:size&#40;post_grid&#41;&#91;1&#93;&#41;, Weights&#40;post_prob&#41;,
                     10_000, replace &#61; true&#41;
sample_μ &#61; all_μ&#91;sample_rows&#93;
sample_σ &#61; all_σ&#91;sample_rows&#93;

figure_4_4 &#61; scatter&#40;sample_μ, sample_σ, lab &#61; &quot;&quot;, aspect_ratio &#61; 1.5,
                     xlab &#61; &quot;μ&quot;, ylab &#61; &quot;σ&quot;, markeralpha&#61;0.1, markersize&#61;3&#41;;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/figure_4_4.svg" alt="">
<h2 id=figure_45 ><a href="#figure_45" class=header-anchor >Figure 4.5</a></h2>
<p>We now condition the model on the height data, then use the NUTS sampler to produce a single chain.</p>
<pre><code class=language-julia >m4_1_model &#61; m4_1&#40;howell.height&#41;
m4_1_chains &#61; sample&#40;m4_1_model, NUTS&#40;0.65&#41;, 1000&#41;
m4_1_chains_plot &#61; plot&#40;m4_1_chains&#41;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/m4_1_plot.svg" alt="Chains for model 4_1">
<p>We can use <code>optimize&#40;&#41;</code> in combination with <code>MAP&#40;&#41;</code> to find the MAP, and we can print the variance-covariance matrix, just like in the book.</p>
<pre><code class=language-julia >m4_1_map_estimate &#61; optimize&#40;m4_1_model, MAP&#40;&#41;&#41;
vcov&#40;m4_1_map_estimate&#41;</code></pre><pre><code class=plaintext >2×2 Named Matrix{Float64}
A ╲ B │        :σ         :μ
──────┼─────────────────────
:σ    │  -7.65056  -0.122765
:μ    │ -0.122765     6.9764</code></pre>
<h3 id=m42 ><a href="#m42" class=header-anchor >m4.2</a></h3>
<p>We conduct a similar analysis for the second model which uses a different prior on μ.</p>
<pre><code class=language-julia >m4_2_model &#61; m4_2&#40;howell.height&#41;
m4_2_chains &#61; sample&#40;m4_2_model, NUTS&#40;0.65&#41;, 1000&#41;
m4_2_chains_plot &#61;plot&#40;m4_2_chains&#41;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/m4_2_plot.svg" alt="Chains for model 4_2">
<p>Similarly we get the MAP and the variance-covariance matrix.</p>
<pre><code class=language-julia >m4_2_map_estimate &#61; optimize&#40;m4_2_model, MAP&#40;&#41;&#41;
vcov&#40;m4_2_map_estimate&#41;</code></pre><pre><code class=plaintext >2×2 Named Matrix{Float64}
A ╲ B │         :σ          :μ
──────┼───────────────────────
:σ    │   0.862899  0.00953452
:μ    │ 0.00953452   0.0100471</code></pre>
<p>In what follows, we use two different models that only differs by their prior for β, in the goal of reproduction <strong>figure 4.5 &#40;page 95&#41;</strong>. We first condition the models on the data. Here the missing argument has to do with centering of the value and is useful for later when we use the model for predictions.</p>
<pre><code class=language-julia >m4_3_model &#61; m4_3&#40;howell.height, howell.weight, missing&#41;
m4_3_2_model &#61; m4_3_2&#40;howell.height, howell.weight, missing&#41;;</code></pre>
<h4 id=prior_predictive_check ><a href="#prior_predictive_check" class=header-anchor >Prior predictive check</a></h4>
<p>We draw 100 samples from the Prior distributions.</p>
<pre><code class=language-julia >m4_3_chains_prior &#61; sample&#40;m4_3_model, Prior&#40;&#41;, 100&#41;
m4_3_2_chains_prior &#61; sample&#40;m4_3_2_model, Prior&#40;&#41;, 100&#41;;</code></pre>
<p>We can now reproduce the figure, first with the left plot for the first prior.</p>
<pre><code class=language-julia >xi &#61; minimum&#40;howell.weight&#41;:0.1:maximum&#40;howell.weight&#41;

p &#61; plot&#40;&#41;;

for row in 1:length&#40;m4_3_chains_prior&#41;
    yi &#61; m4_3_chains_prior&#91;:α&#93;&#91;row&#93; .&#43; m4_3_chains_prior&#91;:β&#93;&#91;row&#93; .* &#40;xi .- mean&#40;howell.weight&#41;&#41;
    plot&#33;&#40;p, xi, yi, alpha&#61;0.3, color&#61;&quot;#000000&quot;, lab&#61;&quot;&quot;&#41;
end

hline&#33;&#40;p, &#91;0&#93;, ls&#61;:dash, color&#61;&quot;#000000&quot;, lab&#61;&quot;&quot;&#41;;
hline&#33;&#40;p, &#91;272&#93;, color&#61;&quot;#000000&quot;, lab&#61;&quot;&quot;&#41;;
plot&#33;&#40;p, ylims &#61; &#91;-100, 400&#93;, title&#61;&quot;log&#40;b&#41; ~ N&#40;0, 1&#41;&quot;, xlab&#61;&quot;weight&quot;, ylab&#61;&quot;height&quot;, lab&#61;&quot;&quot;&#41;;</code></pre>
<p>Then with the right plot for the other prior.</p>
<pre><code class=language-julia >p2 &#61; plot&#40;&#41;;

for row in 1:length&#40;m4_3_2_chains_prior&#41;
    yi &#61; m4_3_2_chains_prior&#91;:α&#93;&#91;row&#93; .&#43; m4_3_2_chains_prior&#91;:β&#93;&#91;row&#93; .* &#40;xi .- mean&#40;howell.weight&#41;&#41;
    plot&#33;&#40;p2, xi, yi, alpha&#61;0.3, color&#61;&quot;#000000&quot;, lab&#61;&quot;&quot;&#41;
end

hline&#33;&#40;p2, &#91;0&#93;, ls&#61;:dash, color&#61;&quot;#000000&quot;, lab&#61;&quot;&quot;&#41;;
hline&#33;&#40;p2, &#91;272&#93;, color&#61;&quot;#000000&quot;, lab&#61;&quot;&quot;&#41;;
plot&#33;&#40;p2, ylims &#61; &#91;-100, 400&#93;, title&#61;&quot;log&#40;b&#41; ~ N&#40;0, 10&#41;&quot;, xlab&#61;&quot;weight&quot;, ylab&#61;&quot;height&quot;, lab&#61;&quot;&quot;&#41;;

figure_4_5 &#61; plot&#40;p, p2, layout &#61; &#40;1, 2&#41;, legend &#61; false&#41;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/figure_4_5.svg" alt="">
<h2 id=figure_46 ><a href="#figure_46" class=header-anchor >Figure 4.6</a></h2>
<h4 id=sampling ><a href="#sampling" class=header-anchor >Sampling</a></h4>
<p>We can now move onto sampling the posterior. Note that the following code samples only one chain using a NUTS sampler, but Turing has other samplers, for instance the <code>MCMC&#40;&#41;</code> sampler, and can be used as such: <code>m4_3_chains &#61; sample&#40;m4_3_model, NUTS&#40;&#41;, MCMCThreads&#40;&#41;, 1000, 4&#41;</code> &#40;this samples 4 chains&#41;.</p>
<pre><code class=language-julia >m4_3_chains &#61; sample&#40;m4_3_model, NUTS&#40;0.65&#41;, 1000&#41;
m4_3_chains_plot &#61; plot&#40;m4_3_chains&#41;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/m4_3_plot.svg" alt="Chains for model 4_3">
<pre><code class=language-julia >m4_3_map_estimate &#61; optimize&#40;m4_3_model, MAP&#40;&#41;&#41;
vcov&#40;m4_3_map_estimate&#41;</code></pre><pre><code class=plaintext >3×3 Named Matrix{Float64}
A ╲ B │           :α            :β            :σ
──────┼─────────────────────────────────────────
:α    │    0.0710102  -5.60586e-88    1.91173e-5
:β    │ -5.60586e-88   1.38389e-85  -3.37388e-85
:σ    │   1.91173e-5  -3.37388e-85     0.0115057</code></pre>
<p>Here is a plot of the data, similar to <strong>figure 4.6 &#40;page 101&#41;</strong>.</p>
<pre><code class=language-julia >p &#61; scatter&#40;howell.weight, howell.height, xlab&#61;&quot;weight&quot;, ylab&#61;&quot;height&quot;, lab&#61;&quot;&quot;&#41;;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/figure_4_6.svg" alt="">
<h2 id=figure_47 ><a href="#figure_47" class=header-anchor >Figure 4.7</a></h2>
<p>For this figure we plot an increasing number of points to show the uncertainty decreasing as N increases.</p>
<pre><code class=language-julia >howell_10 &#61; howell&#91;1:10,:&#93;
howell_50 &#61; howell&#91;1:50,:&#93;
howell_150 &#61; howell&#91;1:150,:&#93;

m4_3_model_N10 &#61; m4_3&#40;howell_10.height, howell_10.weight, missing&#41;
m4_3_model_N50 &#61; m4_3&#40;howell_50.height, howell_50.weight, missing&#41;
m4_3_model_N150 &#61; m4_3&#40;howell_150.height, howell_150.weight, missing&#41;

m4_3_N10_chains &#61; sample&#40;m4_3_model_N10, NUTS&#40;0.65&#41;, 1000&#41;
m4_3_N50_chains &#61; sample&#40;m4_3_model_N50, NUTS&#40;0.65&#41;, 1000&#41;
m4_3_N150_chains &#61; sample&#40;m4_3_model_N150, NUTS&#40;0.65&#41;, 1000&#41;

the_20_rows &#61; sample&#40;1:1000, 20&#41;

samples_N_all &#61; DataFrame&#40;m4_3_chains&#41;&#91;the_20_rows,&#91;:α,:β&#93;&#93;
samples_N10 &#61; DataFrame&#40;m4_3_N10_chains&#41;&#91;the_20_rows,&#91;:α,:β&#93;&#93;
samples_N50 &#61; DataFrame&#40;m4_3_N50_chains&#41;&#91;the_20_rows,&#91;:α,:β&#93;&#93;
samples_N150 &#61; DataFrame&#40;m4_3_N150_chains&#41;&#91;the_20_rows,&#91;:α,:β&#93;&#93;

function make_plot&#40;dat, samples, N&#41;
    p_new &#61; scatter&#40;dat.weight, dat.height, xlab&#61;&quot;weight&quot;, ylab&#61;&quot;height&quot;, lab&#61;&quot;&quot;&#41;;
    for row in eachrow&#40;samples&#41;
        y &#61; row.α .&#43; row.β .* &#40;dat.weight .- mean&#40;dat.weight&#41;&#41;
        plot&#33;&#40;p_new, dat.weight, y, alpha&#61;0.1, color&#61;&quot;#000000&quot;, lab&#61;&quot;&quot;,
              title &#61; &quot;N &#61; &#36;N&quot;&#41;
    end
    return&#40;p_new&#41;
end

p_10 &#61; make_plot&#40;howell_10, samples_N10, 10&#41;
p_50 &#61; make_plot&#40;howell_50, samples_N50, 50&#41;
p_150 &#61; make_plot&#40;howell_150, samples_N150, 150&#41;
p_all &#61; make_plot&#40;howell, samples_N_all, 352&#41;

figure_4_7 &#61; plot&#40;p_10, p_50, p_150, p_all, layout &#61; &#40;2,2&#41;&#41;;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/figure_4_7.svg" alt="">
<h2 id=figure_48 ><a href="#figure_48" class=header-anchor >Figure 4.8</a></h2>
<p>We plot the posterior of height for weight &#61; 50.</p>
<pre><code class=language-julia >μ_at_50 &#61; samples_N_all.α .&#43; samples_N_all.β .* &#40;50 - mean&#40;howell.weight&#41;&#41;

figure_4_8 &#61; density&#40;μ_at_50, xlab&#61;&quot;μ | weight &#61; 50&quot;, ylab&#61;&quot;Density&quot;, lab&#61;&quot;&quot;&#41;;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/figure_4_8.svg" alt="">
<h2 id=figure_49 ><a href="#figure_49" class=header-anchor >Figure 4.9</a></h2>
<p>We can use our posterior samples for credible height nad reproduce the <strong>left panel of **figure 4.9 &#40;page 106&#41;</strong>.</p>
<pre><code class=language-julia >p &#61; scatter&#40;howell.weight, howell.height, xlab&#61;&quot;weight&quot;, ylab&#61;&quot;height&quot;, lab&#61;&quot;&quot;&#41;

for row in 1:length&#40;m4_3_chains&#41;
    yi &#61; m4_3_chains&#91;:α&#93;&#91;row&#93; .&#43; m4_3_chains&#91;:β&#93;&#91;row&#93; .* &#40;xi .- mean&#40;howell.weight&#41;&#41;
    plot&#33;&#40;p, xi, yi, alpha&#61;0.01, color&#61;&quot;#000000&quot;, lab&#61;&quot;&quot;&#41;;
end</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/figure_4_9_a.svg" alt="">
<h4 id=compatibility_interval ><a href="#compatibility_interval" class=header-anchor >Compatibility interval</a></h4>
<p>To produce a Compatibility interval, I copied code from this <a href="https://stackoverflow.com/questions/62028147/plotting- credible-intervals-in--from-turing-model">stackoverflow question</a>.</p>
<pre><code class=language-julia >res_4_3 &#61; DataFrame&#40;m4_3_chains&#41;

function m4_3_model_eq&#40;weight, α, β, mean_weight&#41;
    height &#61; α &#43; β * &#40;weight .- mean_weight&#41;
end

arr_4_3 &#61; &#91;m4_3_model_eq.&#40;w, res_4_3.α, res_4_3.β, mean&#40;howell.weight&#41;&#41; for w in xi&#93;

function compat_interval&#40;lower_bound, upper_bound, array&#41;
    mean_vector &#61; &#91;mean&#40;v&#41; for v in array&#93;
    quantiles &#61; &#91;quantile&#40;v, &#91;lower_bound, upper_bound&#93;&#41; for v in array&#93;
    lower &#61; &#91;q&#91;1&#93; - m for &#40;q, m&#41; in zip&#40;quantiles, mean_vector&#41;&#93;
    upper &#61; &#91;q&#91;2&#93; - m for &#40;q, m&#41; in zip&#40;quantiles, mean_vector&#41;&#93;
    return lower, mean_vector, upper
end

compat_interval_4_3 &#61; compat_interval&#40;0.1, 0.9, arr_4_3&#41;

p2 &#61; scatter&#40;howell.weight, howell.height, lab&#61;&quot;&quot;&#41;
plot&#33;&#40;p2, xi, compat_interval_4_3&#91;2&#93;,
      ribbon &#61; &#91;compat_interval_4_3&#91;1&#93;, compat_interval_4_3&#91;3&#93;&#93;,
      xlab&#61;&quot;weight&quot;, ylab&#61;&quot;height&quot;, lab&#61;&quot;&quot;&#41;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/figure_4_9_b.svg" alt="">
<h2 id=figure_410 ><a href="#figure_410" class=header-anchor >Figure 4.10</a></h2>
<h4 id=prediction_interval ><a href="#prediction_interval" class=header-anchor >Prediction interval</a></h4>
<p>The prediction interval is a little trickier as it requires to set an empty vector in lieu of the weight data. We this we can reproduce <strong>figure 4.10 &#40;page 109&#41;</strong>.</p>
<pre><code class=language-julia >x_pred &#61; xi

m4_3_test &#61; m4_3&#40;Vector&#123;Union&#123;Missing, Float64&#125;&#125;&#40;undef, length&#40;x_pred&#41;&#41;,
                 vcat&#40;x_pred&#41;, mean&#40;howell.weight&#41;&#41;;

function predict_interval&#40;test, chains, var&#41;

    predictions &#61; predict&#40;test, chains&#41;
    pred_array &#61; Array&#40;group&#40;predictions, var&#41;&#41;
    quantiles_pred &#61; &#91;quantile&#40;col, &#91;0.1, 0.9&#93;&#41; for col in eachcol&#40;pred_array&#41;&#93;

    m_pred &#61; &#91;mean&#40;v&#41; for v in eachcol&#40;pred_array&#41;&#93;
    lower_pred &#61; &#91;q&#91;1&#93; - m for &#40;q, m&#41; in zip&#40;quantiles_pred, m_pred&#41;&#93;
    upper_pred &#61; &#91;q&#91;2&#93; - m for &#40;q, m&#41; in zip&#40;quantiles_pred, m_pred&#41;&#93;

    return&#40;lower_pred, m_pred, upper_pred&#41;
end

predict_interval_4_3 &#61; predict_interval&#40;m4_3_test, m4_3_chains, &quot;height&quot;&#41;

p3 &#61; scatter&#40;howell.weight, howell.height, lab&#61;&quot;&quot;&#41;
plot&#33;&#40;p3, xi, compat_interval_4_3&#91;2&#93;,
      ribbon &#61; &#91;compat_interval_4_3&#91;1&#93;, compat_interval_4_3&#91;3&#93;&#93;, lab&#61;&quot;&quot;&#41;
plot&#33;&#40;p3, x_pred, predict_interval_4_3&#91;2&#93;,
      ribbon &#61; &#91;predict_interval_4_3&#91;1&#93;, predict_interval_4_3&#91;3&#93;&#93;,
      xlab&#61;&quot;weight&quot;, ylab&#61;&quot;height&quot;, lab&#61;&quot;&quot;&#41;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/figure_4_10.svg" alt="">
<h2 id=figure_411 ><a href="#figure_411" class=header-anchor >Figure 4.11</a></h2>
<p>For what follows, let&#39;s reload the data with all rows. We also standardize weights and create polynomial variables for weights.</p>
<pre><code class=language-julia >howell_all &#61; CSV.read&#40;data_path, DataFrame; delim&#61;&#39;;&#39;&#41;;
howell_all.weight_s &#61; &#40;howell_all.weight .- mean&#40;howell_all.weight&#41;&#41;./std&#40;howell_all.weight&#41;
howell_all.weight_s2 &#61; howell_all.weight_s.^2
howell_all.weight_s3 &#61; howell_all.weight_s.^3;</code></pre>
<p>We can now condition the model on data and sample.</p>
<pre><code class=language-julia >m4_5_model &#61; m4_5&#40;howell_all.height, howell_all.weight_s, howell_all.weight_s2&#41;
m4_5_chains &#61; sample&#40;m4_5_model, NUTS&#40;0.65&#41;, 1000&#41;

m4_5_chains_plot &#61; plot&#40;m4_5_chains&#41;;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/m4_5_plot.svg" alt="Chains for model 4_5">
<p>Similarly for the cubic model:</p>
<pre><code class=language-julia >m4_5_2_model &#61; m4_5_2&#40;howell_all.height, howell_all.weight_s, howell_all.weight_s2, howell_all.weight_s3&#41;
m4_5_2_chains &#61; sample&#40;m4_5_2_model, NUTS&#40;0.65&#41;, 1000&#41;

m4_5_2_chains_plot &#61; plot&#40;m4_5_2_chains&#41;;</code></pre>
<img src="/stats_rethinking_julia/assets/chapters/chap_4/code/output/m4_5_2_plot.svg" alt="Chains for model 4_5_2">
<p>To reproduce <strong>figure 4.11 &#40;page112&#41;</strong>, we need to repeat the process for figure 4.10. We start with the linear model for all the data.</p>
<pre><code class=language-julia >xi_s &#61; minimum&#40;howell_all.weight_s&#41;:0.1:maximum&#40;howell_all.weight_s&#41;
x_pred_s &#61; xi_s

m4_3_model_s &#61; m4_3&#40;howell_all.height, howell_all.weight_s, 0&#41;
m4_3_chains_s &#61; sample&#40;m4_3_model_s, NUTS&#40;0.65&#41;, 1000&#41;
res_4_3_s &#61; DataFrame&#40;m4_3_chains_s&#41;
arr_4_3_s &#61; &#91;m4_3_model_eq.&#40;w, res_4_3_s.α, res_4_3_s.β, 0&#41; for w in xi_s&#93;

compat_interval_4_3_s &#61; compat_interval&#40;0.1, 0.9, arr_4_3_s&#41;

m4_3_test_s &#61; m4_3&#40;Vector&#123;Union&#123;Missing, Float64&#125;&#125;&#40;undef, length&#40;x_pred_s&#41;&#41;,
              vcat&#40;x_pred_s&#41;, mean&#40;howell_all.weight_s&#41;&#41;;
predict_interval_4_3_s &#61; predict_interval&#40;m4_3_test_s, m4_3_chains_s, &quot;height&quot;&#41;

p1 &#61; scatter&#40;howell_all.weight_s, howell_all.height,
            xlab&#61;&quot;weight_s&quot;, ylab&#61;&quot;height&quot;, lab&#61;&quot;&quot;&#41;
plot&#33;&#40;p1, xi_s, compat_interval_4_3_s&#91;2&#93;,
      ribbon &#61; &#91;compat_interval_4_3_s&#91;1&#93;, compat_interval_4_3_s&#91;3&#93;&#93;, lab&#61;&quot;&quot;&#41;
plot&#33;&#40;p1, x_pred_s, predict_interval_4_3_s&#91;2&#93;,
      ribbon &#61; &#91;predict_interval_4_3_s&#91;1&#93;, predict_interval_4_3_s&#91;3&#93;&#93;, lab&#61;&quot;&quot;&#41;</code></pre><pre><code class=plaintext >Plot{Plots.GRBackend() n=3}</code></pre>
<h2 id=figure_412 ><a href="#figure_412" class=header-anchor >Figure 4.12</a></h2>
<p>TODO</p>
<h2 id=figure_413 ><a href="#figure_413" class=header-anchor >Figure 4.13</a></h2>
<p>TODO</p>

<div class=page-foot >
  <div class=copyright >
    &copy; Valentin Lucet (theme modified from SymbolicsUtils.jl). Last modified: March 28, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and <a href="https://github.com/tlienart/PkgPage.jl">PkgPage.jl</a>.
  </div>
</div>
</div>
    </div>  
    
    <script>
        var els =  document.querySelectorAll(".language-julia")
        for (var i=0, l = els.length; i < l; i++) {
            var el = els[i]
            var out = el.parentNode.nextSibling
            if (out.tagName === "PRE") {
                out.className = out.className + " code-output"
            }
        }
    </script>
    
        <script src="/stats_rethinking_julia/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>